services:
  # ============================================================================
  # PostgreSQL - Production Configuration
  # ============================================================================
  postgres:
    image: postgres:15-alpine
    container_name: minsik-postgres
    env_file: .env
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      # Production-optimized settings
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
    # NO EXPOSED PORTS - internal network only (security)
    volumes:
      # Persistent data storage
      - postgres_data:/var/lib/postgresql/data
      # Initialize database schemas on first run
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
      # Optional: Custom PostgreSQL configuration
      # - ./config/postgresql.conf:/etc/postgresql/postgresql.conf
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M
    networks:
      - minsik-internal
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    # Security: Run as non-root user (PostgreSQL does this by default)
    user: postgres

  # ============================================================================
  # Redis - Production Configuration
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: minsik-redis
    env_file: .env
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 128mb
      --maxmemory-policy allkeys-lru
      --save 300 10
      --save 900 1
      --appendonly yes
      --appendfsync everysec
      --tcp-backlog 128
      --timeout 300
      --tcp-keepalive 300
      --maxclients 50
    # NO EXPOSED PORTS - internal network only (security)
    volumes:
      # Persistent data storage (AOF + RDB snapshots)
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 60s
      timeout: 5s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 128M
    networks:
      - minsik-internal
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    # Security: Run as non-root user (Redis does this by default)
    user: redis

  # ============================================================================
  # Elasticsearch - Production Configuration
  # ============================================================================
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.17.4
    container_name: minsik-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
    # NO EXPOSED PORTS - internal network only (security)
    volumes:
      - es_data:/usr/share/elasticsearch/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -sf http://localhost:9200/_cluster/health || exit 1",
        ]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1536M
        reservations:
          cpus: "0.5"
          memory: 1G
    networks:
      - minsik-internal
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # ============================================================================
  # Gateway Service - Production Configuration
  # ============================================================================
  gateway-service:
    image: europe-central2-docker.pkg.dev/minsik-486117/server/gateway-service:latest
    container_name: minsik-gateway-service
    environment:
      ENV: production
      DEBUG: false
      LOG_LEVEL: ${LOG_LEVEL}
      GATEWAY_HOST: 0.0.0.0
      GATEWAY_HTTP_PORT: ${GATEWAY_HTTP_PORT}
      GATEWAY_WORKERS: ${GATEWAY_WORKERS}
      INGESTION_SERVICE_HOST: ${INGESTION_SERVICE_HOST}
      INGESTION_GRPC_PORT: ${INGESTION_GRPC_PORT}
      BOOKS_SERVICE_HOST: ${BOOKS_SERVICE_HOST}
      BOOKS_GRPC_PORT: ${BOOKS_GRPC_PORT}
      AUTH_SERVICE_HOST: ${AUTH_SERVICE_HOST}
      AUTH_GRPC_PORT: ${AUTH_GRPC_PORT}
      USER_DATA_SERVICE_HOST: ${USER_DATA_SERVICE_HOST}
      USER_DATA_GRPC_PORT: ${USER_DATA_GRPC_PORT}
      GRPC_KEEPALIVE_TIME_MS: ${GRPC_KEEPALIVE_TIME_MS}
      GRPC_KEEPALIVE_TIMEOUT_MS: ${GRPC_KEEPALIVE_TIMEOUT_MS}
      GRPC_TIMEOUT: ${GRPC_TIMEOUT}
      GRPC_ADMIN_TIMEOUT: ${GRPC_ADMIN_TIMEOUT}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_ALGORITHM: ${JWT_ALGORITHM}
      JWT_ACCESS_TOKEN_EXPIRE_MINUTES: ${JWT_ACCESS_TOKEN_EXPIRE_MINUTES}
      CORS_ORIGINS: "https://minsik.app,https://www.minsik.app"
      CORS_ALLOW_CREDENTIALS: "true"
      CORS_ALLOW_METHODS: "GET,POST,PUT,DELETE,PATCH"
      CORS_ALLOW_HEADERS: "Content-Type,Authorization"
    ports:
      - "127.0.0.1:${GATEWAY_HTTP_PORT}:8040"
    depends_on:
      - ingestion-service
      - books-service
      - auth-service
      - user-data-service
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M
    networks:
      - minsik-internal
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # ============================================================================
  # Ingestion Service - Production Configuration
  # ============================================================================
  ingestion-service:
    image: europe-central2-docker.pkg.dev/minsik-486117/server/ingestion-service:latest
    container_name: minsik-ingestion-service
    environment:
      ENV: production
      DEBUG: false
      LOG_LEVEL: ${LOG_LEVEL}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_POOL_SIZE: ${INGESTION_DB_POOL_SIZE}
      DB_MAX_OVERFLOW: ${INGESTION_DB_MAX_OVERFLOW}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_DB: ${REDIS_DB}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_MAX_CONNECTIONS: ${INGESTION_REDIS_MAX_CONNECTIONS}
      INGESTION_SERVICE_HOST: 0.0.0.0
      INGESTION_GRPC_PORT: ${INGESTION_GRPC_PORT}
      OPEN_LIBRARY_API_URL: ${OPEN_LIBRARY_API_URL}
      OPEN_LIBRARY_RATE_LIMIT: ${OPEN_LIBRARY_RATE_LIMIT}
      GOOGLE_BOOKS_API_URL: ${GOOGLE_BOOKS_API_URL}
      GOOGLE_BOOKS_API_KEY: ${GOOGLE_BOOKS_API_KEY}
      REQUEST_TIMEOUT: ${REQUEST_TIMEOUT}
      CLEANUP_ENABLED: ${CLEANUP_ENABLED}
      CLEANUP_INTERVAL_HOURS: ${CLEANUP_INTERVAL_HOURS}
      CLEANUP_BATCH_SIZE: ${CLEANUP_BATCH_SIZE}
      CLEANUP_BOOK_MIN_QUALITY_SCORE: ${CLEANUP_BOOK_MIN_QUALITY_SCORE}
      CLEANUP_AUTHOR_MIN_BOOKS: ${CLEANUP_AUTHOR_MIN_BOOKS}
      DUMP_COMMIT_INTERVAL: ${DUMP_COMMIT_INTERVAL}
      DUMP_EDITION_BATCH_SIZE: ${DUMP_EDITION_BATCH_SIZE}
      DUMP_EDITIONS_ENABLED: ${DUMP_EDITIONS_ENABLED}
      DUMP_RATINGS_ENABLED: ${DUMP_RATINGS_ENABLED}
      DUMP_READING_LOG_ENABLED: ${DUMP_READING_LOG_ENABLED}
      DUMP_WIKIDATA_ENABLED: ${DUMP_WIKIDATA_ENABLED}
    # NO EXPOSED PORTS - internal network only (security)
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 4096M
        reservations:
          cpus: "0.5"
          memory: 512M
    networks:
      - minsik-internal
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # ============================================================================
  # Books Service - Production Configuration
  # ============================================================================
  books-service:
    image: europe-central2-docker.pkg.dev/minsik-486117/server/books-service:latest
    container_name: minsik-books-service
    environment:
      ENV: production
      DEBUG: false
      LOG_LEVEL: ${LOG_LEVEL}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_POOL_SIZE: ${BOOKS_DB_POOL_SIZE}
      DB_MAX_OVERFLOW: ${BOOKS_DB_MAX_OVERFLOW}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_DB: ${REDIS_DB}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_MAX_CONNECTIONS: ${BOOKS_REDIS_MAX_CONNECTIONS}
      BOOKS_SERVICE_HOST: 0.0.0.0
      BOOKS_GRPC_PORT: ${BOOKS_GRPC_PORT}
      CACHE_BOOK_DETAIL_TTL: ${CACHE_BOOK_DETAIL_TTL}
      CACHE_AUTHOR_DETAIL_TTL: ${CACHE_AUTHOR_DETAIL_TTL}
      CACHE_AUTHOR_BOOKS_TTL: ${CACHE_AUTHOR_BOOKS_TTL}
      CACHE_SEARCH_TTL: ${CACHE_SEARCH_TTL}
      VIEW_COUNT_FLUSH_INTERVAL: ${VIEW_COUNT_FLUSH_INTERVAL}
      SEARCH_AUTHOR_BOOKS_EXPANSION: ${SEARCH_AUTHOR_BOOKS_EXPANSION}
      ES_HOST: ${ES_HOST}
      ES_PORT: ${ES_PORT}
      ES_INDEX_BOOKS: ${ES_INDEX_BOOKS}
      ES_INDEX_AUTHORS: ${ES_INDEX_AUTHORS}
      ES_INDEX_SERIES: ${ES_INDEX_SERIES}
      ES_REINDEX_INTERVAL_HOURS: ${ES_REINDEX_INTERVAL_HOURS}
      ES_REINDEX_BATCH_SIZE: ${ES_REINDEX_BATCH_SIZE}
    # NO EXPOSED PORTS - internal network only (security)
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M
    networks:
      - minsik-internal
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # ============================================================================
  # Auth Service - Production Configuration
  # ============================================================================
  auth-service:
    image: europe-central2-docker.pkg.dev/minsik-486117/server/auth-service:latest
    container_name: minsik-auth-service
    environment:
      ENV: production
      DEBUG: false
      LOG_LEVEL: ${LOG_LEVEL}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_POOL_SIZE: ${AUTH_DB_POOL_SIZE}
      DB_MAX_OVERFLOW: ${AUTH_DB_MAX_OVERFLOW}
      AUTH_SERVICE_HOST: 0.0.0.0
      AUTH_GRPC_PORT: ${AUTH_GRPC_PORT}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_ALGORITHM: ${JWT_ALGORITHM}
      JWT_ACCESS_TOKEN_EXPIRE_MINUTES: ${JWT_ACCESS_TOKEN_EXPIRE_MINUTES}
      JWT_REFRESH_TOKEN_EXPIRE_DAYS: ${JWT_REFRESH_TOKEN_EXPIRE_DAYS}
    # NO EXPOSED PORTS - internal network only (security)
    depends_on:
      postgres:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M
    networks:
      - minsik-internal
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # ============================================================================
  # User Data Service - Production Configuration
  # ============================================================================
  user-data-service:
    image: europe-central2-docker.pkg.dev/minsik-486117/server/user-data-service:latest
    container_name: minsik-user-data-service
    environment:
      ENV: production
      DEBUG: false
      LOG_LEVEL: ${LOG_LEVEL}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_POOL_SIZE: ${USER_DATA_DB_POOL_SIZE}
      DB_MAX_OVERFLOW: ${USER_DATA_DB_MAX_OVERFLOW}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_DB: ${REDIS_DB}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_MAX_CONNECTIONS: ${USER_DATA_REDIS_MAX_CONNECTIONS}
      USER_DATA_SERVICE_HOST: 0.0.0.0
      USER_DATA_GRPC_PORT: ${USER_DATA_GRPC_PORT}
    # NO EXPOSED PORTS - internal network only (security)
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M
    networks:
      - minsik-internal
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # ============================================================================
  # RQ Worker - Production Configuration
  # ============================================================================
  rq-worker:
    image: europe-central2-docker.pkg.dev/minsik-486117/server/rq-worker:latest
    container_name: minsik-rq-worker
    env_file: .env
    command: rq worker ingestion --url redis://:${REDIS_PASSWORD}@${REDIS_HOST}:${REDIS_PORT}/${REDIS_DB}
    environment:
      ENV: production
      DEBUG: false
      LOG_LEVEL: ERROR
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_POOL_SIZE: 3
      DB_MAX_OVERFLOW: 5
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_DB: ${REDIS_DB}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_MAX_CONNECTIONS: 10
      OPEN_LIBRARY_API_URL: ${OPEN_LIBRARY_API_URL}
      OPEN_LIBRARY_RATE_LIMIT: ${OPEN_LIBRARY_RATE_LIMIT}
      GOOGLE_BOOKS_API_URL: ${GOOGLE_BOOKS_API_URL}
      GOOGLE_BOOKS_API_KEY: ${GOOGLE_BOOKS_API_KEY}
      REQUEST_TIMEOUT: ${REQUEST_TIMEOUT}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 768M
        reservations:
          cpus: "0.25"
          memory: 384M
    networks:
      - minsik-internal
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

# ============================================================================
# Volumes - Production (persistent, backed up)
# ============================================================================
volumes:
  postgres_data:
    name: minsik-postgres-data
    driver: local
    # In production with Docker Swarm/K8s, use named volumes with backup strategy
    # driver_opts:
    #   type: nfs
    #   o: addr=10.0.0.10,rw
    #   device: ":/path/to/postgres/data"

  redis_data:
    name: minsik-redis-data
    driver: local

  es_data:
    name: minsik-es-data
    driver: local

# ============================================================================
# Networks - Production (isolated internal network)
# ============================================================================
networks:
  minsik-frontend:
    driver: bridge

  minsik-internal:
    driver: bridge
    name: minsik-prod-network
    # Set to true for complete isolation (services can't access internet)
    # Only use if services don't need external API access
    internal: false
    ipam:
      driver: default
      config:
        - subnet: 172.32.0.0/16
