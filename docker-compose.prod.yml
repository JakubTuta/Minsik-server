services:
  # ============================================================================
  # PostgreSQL - Production Configuration
  # ============================================================================
  postgres:
    image: postgres:15-alpine
    container_name: minsik-postgres
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      # Production-optimized settings
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
    # NO EXPOSED PORTS - internal network only (security)
    volumes:
      # Persistent data storage
      - postgres_data:/var/lib/postgresql/data
      # Initialize database schemas on first run
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
      # Optional: Custom PostgreSQL configuration
      # - ./config/postgresql.conf:/etc/postgresql/postgresql.conf
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M
    networks:
      - minsik-internal
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    # Security: Run as non-root user (PostgreSQL does this by default)
    user: postgres

  # ============================================================================
  # Redis - Production Configuration
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: minsik-redis
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 128mb
      --maxmemory-policy allkeys-lru
      --save 300 10
      --save 900 1
      --appendonly yes
      --appendfsync everysec
      --tcp-backlog 128
      --timeout 300
      --tcp-keepalive 300
      --maxclients 50
    # NO EXPOSED PORTS - internal network only (security)
    volumes:
      # Persistent data storage (AOF + RDB snapshots)
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 60s
      timeout: 5s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 128M
    networks:
      - minsik-internal
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    # Security: Run as non-root user (Redis does this by default)
    user: redis

  # ============================================================================
  # Gateway Service - Production Configuration
  # ============================================================================
  gateway-service:
    image: europe-central2-docker.pkg.dev/minsik-486117/server/gateway-service:latest
    container_name: minsik-gateway-service
    environment:
      ENV: production
      DEBUG: false
      LOG_LEVEL: ERROR
      GATEWAY_HOST: 0.0.0.0
      GATEWAY_HTTP_PORT: 8040
      GATEWAY_WORKERS: ${GATEWAY_WORKERS}
      INGESTION_SERVICE_HOST: ${INGESTION_SERVICE_HOST}
      INGESTION_GRPC_PORT: ${INGESTION_GRPC_PORT}
      GRPC_POOL_SIZE: ${GRPC_POOL_SIZE}
      GRPC_KEEPALIVE_TIME_MS: ${GRPC_KEEPALIVE_TIME_MS}
      GRPC_KEEPALIVE_TIMEOUT_MS: ${GRPC_KEEPALIVE_TIMEOUT_MS}
      GRPC_TIMEOUT: ${GRPC_TIMEOUT}
      CORS_ORIGINS: "https://minsik.app,https://www.minsik.app"
      CORS_ALLOW_CREDENTIALS: "true"
      CORS_ALLOW_METHODS: "GET,POST,PUT,DELETE,PATCH"
      CORS_ALLOW_HEADERS: "Content-Type,Authorization"
    ports:
      # EXPOSED to public internet (ONLY exposed service)
      - "8040:8040"
    depends_on:
      - ingestion-service
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M
    networks:
      - minsik-internal
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # ============================================================================
  # Ingestion Service - Production Configuration
  # ============================================================================
  ingestion-service:
    image: europe-central2-docker.pkg.dev/minsik-486117/server/ingestion-service:latest
    container_name: minsik-ingestion-service
    environment:
      ENV: production
      DEBUG: false
      LOG_LEVEL: ERROR
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_POOL_SIZE: 3
      DB_MAX_OVERFLOW: 5
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_DB: ${REDIS_DB}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_MAX_CONNECTIONS: 10
      INGESTION_SERVICE_HOST: 0.0.0.0
      INGESTION_GRPC_PORT: 50054
      OPEN_LIBRARY_API_URL: ${OPEN_LIBRARY_API_URL}
      OPEN_LIBRARY_RATE_LIMIT: ${OPEN_LIBRARY_RATE_LIMIT}
      GOOGLE_BOOKS_API_URL: ${GOOGLE_BOOKS_API_URL}
      GOOGLE_BOOKS_API_KEY: ${GOOGLE_BOOKS_API_KEY}
      REQUEST_TIMEOUT: ${REQUEST_TIMEOUT}
    # NO EXPOSED PORTS - internal network only (security)
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M
    networks:
      - minsik-internal
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # ============================================================================
  # RQ Worker - Production Configuration
  # ============================================================================
  rq-worker:
    image: europe-central2-docker.pkg.dev/minsik-486117/server/rq-worker:latest
    container_name: minsik-rq-worker
    command: rq worker ingestion --url redis://:${REDIS_PASSWORD}@${REDIS_HOST}:${REDIS_PORT}/${REDIS_DB}
    environment:
      ENV: production
      DEBUG: false
      LOG_LEVEL: ERROR
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_POOL_SIZE: 3
      DB_MAX_OVERFLOW: 5
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_DB: ${REDIS_DB}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_MAX_CONNECTIONS: 10
      OPEN_LIBRARY_API_URL: ${OPEN_LIBRARY_API_URL}
      OPEN_LIBRARY_RATE_LIMIT: ${OPEN_LIBRARY_RATE_LIMIT}
      GOOGLE_BOOKS_API_URL: ${GOOGLE_BOOKS_API_URL}
      GOOGLE_BOOKS_API_KEY: ${GOOGLE_BOOKS_API_KEY}
      REQUEST_TIMEOUT: ${REQUEST_TIMEOUT}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 768M
        reservations:
          cpus: "0.25"
          memory: 384M
    networks:
      - minsik-internal
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

# ============================================================================
# Volumes - Production (persistent, backed up)
# ============================================================================
volumes:
  postgres_data:
    driver: local
    # In production with Docker Swarm/K8s, use named volumes with backup strategy
    # driver_opts:
    #   type: nfs
    #   o: addr=10.0.0.10,rw
    #   device: ":/path/to/postgres/data"

  redis_data:
    driver: local

# ============================================================================
# Networks - Production (isolated internal network)
# ============================================================================
networks:
  minsik-internal:
    driver: bridge
    name: minsik-prod-network
    # Set to true for complete isolation (services can't access internet)
    # Only use if services don't need external API access
    internal: false
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16
