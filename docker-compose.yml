services:
  # ============================================================================
  # PostgreSQL - Development Configuration
  # ============================================================================
  postgres:
    image: postgres:15-alpine
    container_name: minsik-postgres-dev
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      # Development-friendly settings
      POSTGRES_INITDB_ARGS: "--encoding=UTF8"
    ports:
      # EXPOSED for local access (DB clients, debugging)
      - "${DB_PORT}:5432"
    volumes:
      # Data persistence
      - postgres_data_dev:/var/lib/postgresql/data
      # Initialize database schemas on first run
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - minsik-network
    restart: unless-stopped
    # No resource limits in development (use all available)

  # ============================================================================
  # Redis - Development Configuration
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: minsik-redis-dev
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --save ""
      --appendonly no
    ports:
      # EXPOSED for local access (Redis CLI, debugging)
      - "${REDIS_PORT}:6379"
    volumes:
      # Data persistence (optional in dev, useful for testing)
      - redis_data_dev:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - minsik-network
    restart: unless-stopped

  # ============================================================================
  # Elasticsearch - Development Configuration
  # ============================================================================
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.17.4
    container_name: minsik-elasticsearch-dev
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ports:
      # EXPOSED for local access (Kibana, debugging)
      - "9200:9200"
    volumes:
      - es_data_dev:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9200/_cluster/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - minsik-network
    restart: unless-stopped
    # No resource limits in development

  # ============================================================================
  # Gateway Service - Development Configuration
  # ============================================================================
  gateway-service:
    build:
      context: .
      dockerfile: services/gateway/Dockerfile
    container_name: minsik-gateway-service-dev
    environment:
      ENV: development
      DEBUG: ${DEBUG}
      LOG_LEVEL: ${LOG_LEVEL}
      GATEWAY_HOST: ${GATEWAY_HOST}
      GATEWAY_HTTP_PORT: ${GATEWAY_HTTP_PORT}
      GATEWAY_WORKERS: ${GATEWAY_WORKERS}
      INGESTION_SERVICE_HOST: ${INGESTION_SERVICE_HOST}
      INGESTION_GRPC_PORT: ${INGESTION_GRPC_PORT}
      BOOKS_SERVICE_HOST: ${BOOKS_SERVICE_HOST}
      BOOKS_GRPC_PORT: ${BOOKS_GRPC_PORT}
      AUTH_SERVICE_HOST: ${AUTH_SERVICE_HOST}
      AUTH_GRPC_PORT: ${AUTH_GRPC_PORT}
      USER_DATA_SERVICE_HOST: ${USER_DATA_SERVICE_HOST}
      USER_DATA_GRPC_PORT: ${USER_DATA_GRPC_PORT}
      GRPC_KEEPALIVE_TIME_MS: ${GRPC_KEEPALIVE_TIME_MS}
      GRPC_KEEPALIVE_TIMEOUT_MS: ${GRPC_KEEPALIVE_TIMEOUT_MS}
      GRPC_TIMEOUT: ${GRPC_TIMEOUT}
      GRPC_ADMIN_TIMEOUT: ${GRPC_ADMIN_TIMEOUT}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_ALGORITHM: ${JWT_ALGORITHM}
      JWT_ACCESS_TOKEN_EXPIRE_MINUTES: ${JWT_ACCESS_TOKEN_EXPIRE_MINUTES}
      CORS_ORIGINS: "*"
      CORS_ALLOW_CREDENTIALS: "true"
      CORS_ALLOW_METHODS: "*"
      CORS_ALLOW_HEADERS: "*"
    ports:
      # EXPOSED for client access
      - "${GATEWAY_HTTP_PORT}:8040"
    depends_on:
      - ingestion-service
      - books-service
      - auth-service
      - user-data-service
    networks:
      - minsik-network
    restart: unless-stopped
    # No resource limits in development

  # ============================================================================
  # Ingestion Service - Development Configuration
  # ============================================================================
  ingestion-service:
    build:
      context: .
      dockerfile: services/ingestion/Dockerfile
    container_name: minsik-ingestion-service-dev
    environment:
      ENV: development
      DEBUG: ${DEBUG}
      LOG_LEVEL: ${LOG_LEVEL}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_POOL_SIZE: ${DB_POOL_SIZE}
      DB_MAX_OVERFLOW: ${DB_MAX_OVERFLOW}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_DB: ${REDIS_DB}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_MAX_CONNECTIONS: ${REDIS_MAX_CONNECTIONS}
      INGESTION_SERVICE_HOST: ${INGESTION_SERVICE_HOST}
      INGESTION_GRPC_PORT: ${INGESTION_GRPC_PORT}
      OPEN_LIBRARY_API_URL: ${OPEN_LIBRARY_API_URL}
      OPEN_LIBRARY_RATE_LIMIT: ${OPEN_LIBRARY_RATE_LIMIT}
      GOOGLE_BOOKS_API_URL: ${GOOGLE_BOOKS_API_URL}
      GOOGLE_BOOKS_API_KEY: ${GOOGLE_BOOKS_API_KEY}
      REQUEST_TIMEOUT: ${REQUEST_TIMEOUT}
    ports:
      # EXPOSED for local access (gRPC debugging)
      - "${INGESTION_GRPC_PORT}:50054"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - minsik-network
    restart: unless-stopped
    # No resource limits in development

  # ============================================================================
  # Books Service - Development Configuration
  # ============================================================================
  books-service:
    build:
      context: .
      dockerfile: services/books/Dockerfile
    container_name: minsik-books-service-dev
    environment:
      ENV: development
      DEBUG: ${DEBUG}
      LOG_LEVEL: ${LOG_LEVEL}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_POOL_SIZE: ${DB_POOL_SIZE}
      DB_MAX_OVERFLOW: ${DB_MAX_OVERFLOW}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_DB: ${REDIS_DB}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_MAX_CONNECTIONS: ${REDIS_MAX_CONNECTIONS}
      BOOKS_SERVICE_HOST: ${BOOKS_SERVICE_HOST}
      BOOKS_GRPC_PORT: ${BOOKS_GRPC_PORT}
      CACHE_BOOK_DETAIL_TTL: ${CACHE_BOOK_DETAIL_TTL}
      CACHE_AUTHOR_DETAIL_TTL: ${CACHE_AUTHOR_DETAIL_TTL}
      CACHE_AUTHOR_BOOKS_TTL: ${CACHE_AUTHOR_BOOKS_TTL}
      CACHE_SEARCH_TTL: ${CACHE_SEARCH_TTL}
      VIEW_COUNT_FLUSH_INTERVAL: ${VIEW_COUNT_FLUSH_INTERVAL}
      SEARCH_AUTHOR_BOOKS_EXPANSION: ${SEARCH_AUTHOR_BOOKS_EXPANSION}
      ES_HOST: ${ES_HOST}
      ES_PORT: ${ES_PORT}
      ES_INDEX_BOOKS: ${ES_INDEX_BOOKS}
      ES_INDEX_AUTHORS: ${ES_INDEX_AUTHORS}
      ES_INDEX_SERIES: ${ES_INDEX_SERIES}
      ES_REINDEX_INTERVAL_HOURS: ${ES_REINDEX_INTERVAL_HOURS}
      ES_REINDEX_BATCH_SIZE: ${ES_REINDEX_BATCH_SIZE}
    ports:
      # EXPOSED for local access (gRPC debugging)
      - "${BOOKS_GRPC_PORT}:50055"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    networks:
      - minsik-network
    restart: unless-stopped
    # No resource limits in development

  # ============================================================================
  # Auth Service - Development Configuration
  # ============================================================================
  auth-service:
    build:
      context: .
      dockerfile: services/auth/Dockerfile
    container_name: minsik-auth-service-dev
    environment:
      ENV: development
      DEBUG: ${DEBUG}
      LOG_LEVEL: ${LOG_LEVEL}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_POOL_SIZE: ${DB_POOL_SIZE}
      DB_MAX_OVERFLOW: ${DB_MAX_OVERFLOW}
      AUTH_SERVICE_HOST: ${AUTH_SERVICE_HOST}
      AUTH_GRPC_PORT: ${AUTH_GRPC_PORT}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_ALGORITHM: ${JWT_ALGORITHM}
      JWT_ACCESS_TOKEN_EXPIRE_MINUTES: ${JWT_ACCESS_TOKEN_EXPIRE_MINUTES}
      JWT_REFRESH_TOKEN_EXPIRE_DAYS: ${JWT_REFRESH_TOKEN_EXPIRE_DAYS}
    ports:
      # EXPOSED for local access (gRPC debugging)
      - "${AUTH_GRPC_PORT}:50051"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - minsik-network
    restart: unless-stopped
    # No resource limits in development

  # ============================================================================
  # User Data Service - Development Configuration
  # ============================================================================
  user-data-service:
    build:
      context: .
      dockerfile: services/user_data/Dockerfile
    container_name: minsik-user-data-service-dev
    environment:
      ENV: development
      DEBUG: ${DEBUG}
      LOG_LEVEL: ${LOG_LEVEL}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_POOL_SIZE: ${DB_POOL_SIZE}
      DB_MAX_OVERFLOW: ${DB_MAX_OVERFLOW}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_DB: ${REDIS_DB}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_MAX_CONNECTIONS: ${REDIS_MAX_CONNECTIONS}
      USER_DATA_SERVICE_HOST: ${USER_DATA_SERVICE_HOST}
      USER_DATA_GRPC_PORT: ${USER_DATA_GRPC_PORT}
    ports:
      # EXPOSED for local access (gRPC debugging)
      - "${USER_DATA_GRPC_PORT}:50053"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - minsik-network
    restart: unless-stopped
    # No resource limits in development

  # ============================================================================
  # RQ Worker - Development Configuration
  # ============================================================================
  rq-worker:
    build:
      context: .
      dockerfile: services/ingestion/Dockerfile
    container_name: minsik-rq-worker-dev
    command: rq worker ingestion --url redis://:${REDIS_PASSWORD}@${REDIS_HOST}:${REDIS_PORT}/${REDIS_DB}
    environment:
      ENV: development
      DEBUG: ${DEBUG}
      LOG_LEVEL: ${LOG_LEVEL}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_POOL_SIZE: ${DB_POOL_SIZE}
      DB_MAX_OVERFLOW: ${DB_MAX_OVERFLOW}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_DB: ${REDIS_DB}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_MAX_CONNECTIONS: ${REDIS_MAX_CONNECTIONS}
      OPEN_LIBRARY_API_URL: ${OPEN_LIBRARY_API_URL}
      OPEN_LIBRARY_RATE_LIMIT: ${OPEN_LIBRARY_RATE_LIMIT}
      GOOGLE_BOOKS_API_URL: ${GOOGLE_BOOKS_API_URL}
      GOOGLE_BOOKS_API_KEY: ${GOOGLE_BOOKS_API_KEY}
      REQUEST_TIMEOUT: ${REQUEST_TIMEOUT}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - minsik-network
    restart: unless-stopped
    # No resource limits in development

# ============================================================================
# Volumes - Development (named volumes for easy cleanup)
# ============================================================================
volumes:
  postgres_data_dev:
    driver: local
  redis_data_dev:
    driver: local
  es_data_dev:
    driver: local

# ============================================================================
# Networks - Development
# ============================================================================
networks:
  minsik-network:
    driver: bridge
    name: minsik-dev-network
